<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./style2.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <title>ULSAN</title>

  <!-- Leaflet map library -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

</head>

<header class="header">
  <a href="#" class="LOGO">Logo</a>     
  <nav class="navbar">
    <a href="../index.html">Home</a>
    <a href="#about">About</a>
    <a href="#contact">Contact</a>  
    <select id="city-select">
      <option value="./seoul" selected>Seoul</option>
      <option value="./busan">Busan</option>
      <option value="./daegu">Daegu</option>
      <option value="./incheon">Incheon</option>
    </select>
  </nav>
</header>

<body>
  <div class="main-banner" id="top">
    <video autoplay muted loop id="bg-video">
      <source src="./vid/Ulsan.mp4" type="video/mp4" />
    </video>

    <div class="video-overlay header-text">
      <div class="caption">
        <h2>ULSAN</h2>
        <h6>A city full of life and motion.</h6>
      </div>
    </div>
  </div>

  <div class="page2">
    <h1>Waste Monitoring Dashboard</h1>

    <div id="fileContainer">
      <input type="file" id="csvFile" accept=".csv">
    </div>

    <div class="chart-container">
      <canvas id="pieChart"></canvas>
    </div>
    <div class="chart-container">
      <canvas id="lineChart"></canvas>
    </div>

    <table>
      <thead>
        <tr>
          <th>Waste Type</th>
          <th>Count</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- === MAP SECTION === -->
  <h2 style="text-align:center; margin-top:40px;">üó∫Ô∏è Seoul City Map</h2>
  <div id="map"></div>

  <footer class="footer">
    <div class="footer-container">
      <div class="footer-logo">
        <h2>EcoPath üå±</h2>
        <p>Small steps today for a brighter, eco-friendly tomorrow.</p>
      </div>

      <div class="footer-links">
        <h3>Quick Links</h3>
        <ul>
          <li><a href="#home">Home</a></li>
          <li><a href="#about">About</a></li>
          <li><a href="#map">Map</a></li>
          <li><a href="#contact">Contact</a></li>
        </ul>
      </div>

      <div class="footer-contact">
        <h3>Contact</h3>
        <p>Email: info@ecopath.org</p>
        <p>Phone: +82 10-1234-5678</p>
      </div>
    </div>

    <div class="footer-bottom">
      <p>¬© 2025 EcoPath. All rights reserved.</p>
    </div>
  </footer>

  <script>
  // === CITY SELECT SWITCH ===
  document.getElementById('city-select').addEventListener('change', function() {
    const city = this.value;
    window.location.href = `cities/${city}.html`;
  });

  // === CSV CHART + MAP CODE ===
  let pieChart, lineChart;

  const cityCoords = {
    "Seoul": [37.5665, 126.9780],
    "Busan": [35.1796, 129.0756],
    "Daegu": [35.8722, 128.6025],
    "Incheon": [37.4563, 126.7052]
  };

  const map = L.map('map').setView([37.5665, 126.9780], 13);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
    maxZoom: 19,
    attribution: '&copy; <a href="https://carto.com/attributions">CARTO</a>'
  }).addTo(map);

  let circles = []; // store circles to remove old ones

  document.getElementById('csvFile').addEventListener('change', function(e){
    const file = e.target.files[0];
    if (!file) return;

    Papa.parse(file, {
      header: true,
      skipEmptyLines: true,
      complete: function(results) {
        const data = results.data;

        // --- Charts ---
        const wasteTypes = [...new Set(data.map(d => d.WasteType))];
        const wasteTotals = wasteTypes.map(type =>
          data.filter(d => d.WasteType === type)
              .reduce((sum, d) => sum + (parseInt(d.Count) || 0), 0)
        );

        if (pieChart) pieChart.destroy();
        if (lineChart) lineChart.destroy();

        pieChart = new Chart(document.getElementById('pieChart').getContext('2d'), {
          type: 'pie',
          data: {
            labels: wasteTypes,
            datasets: [{
              data: wasteTotals,
              backgroundColor: [
                '#4caf50','#2196f3','#ff9800','#9c27b0','#f44336','#607d8b','#9e9e9e','#795548','#03a9f4','#e91e63'
              ]
            }]
          },
          options: { responsive: true }
        });

        const months = [...new Set(data.map(d => d.Month))].sort((a,b)=>a.localeCompare(b));
        const monthlyTotals = months.map(m =>
          data.filter(d => d.Month === m)
              .reduce((sum, d) => sum + (parseInt(d.Count) || 0), 0)
        );

        lineChart = new Chart(document.getElementById('lineChart').getContext('2d'), {
          type: 'line',
          data: {
            labels: months,
            datasets: [{
              label: 'Total Waste per Month',
              data: monthlyTotals,
              borderColor: '#4caf50',
              backgroundColor: 'rgba(76, 175, 80, 0.2)',
              fill: true,
              tension: 0.3
            }]
          },
          options: { responsive: true }
        });

        const tbody = document.querySelector('table tbody');
        tbody.innerHTML = '';
        wasteTypes.forEach((type,i)=>{
          tbody.innerHTML += `<tr><td>${type}</td><td>${wasteTotals[i]}</td></tr>`;
        });

        // --- MAP: Red circles for crowded cities ---
        // Remove old circles
        circles.forEach(c => map.removeLayer(c));
        circles = [];

        // Compute total waste per city
        const cityTotals = {};
        data.forEach(row => {
          const city = row.City;
          const count = parseInt(row.Count) || 0;
          if (!cityTotals[city]) cityTotals[city] = 0;
          cityTotals[city] += count;
        });

        for (const city in cityTotals) {
          const total = cityTotals[city];
          if (total > 150) { // threshold for crowded
            const coords = cityCoords[city];
            const circle = L.circle(coords, {
              color: '#d90429',
              fillColor: '#ff4d4f',
              fillOpacity: 0.35,
              radius: total * 1.5 // scale radius by total waste
            }).addTo(map)
            .bindPopup(`<b>${city}</b><br>Total Waste: ${total}`);
            circles.push(circle);
          }
        }
      },
      error: function(err){
        alert('Error parsing CSV: '+err);
      }
    });
  });

  // Optional: marker for center
  L.marker([37.5665, 126.9780]).addTo(map)
    .bindPopup('<b>Seoul City Hall</b><br>Welcome to Seoul!')
    .openPopup();
  </script>
</body>
</html>
